<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <script>
      let player,
        bullets = [],
        enemies = [],
        bossBullets = [],
        fragments = [],
        boss;
      let gameTimer = 0,
        BOSS_SPAWN_TIME = 30,
        gameOver = false;
      let leftJoy = { active: false, id: -1, x: 0, y: 0, currX: 0, currY: 0 };
      let rightJoy = { active: false, id: -1, x: 0, y: 0, currX: 0, currY: 0 };
      let joySize = 120;

      function setup() {
        createCanvas(windowWidth, windowHeight);
        player = new Player();
      }

      function draw() {
        if (gameOver) {
          background(0, 150);
          fill(255, 50, 50);
          textAlign(CENTER);
          textSize(40);
          text("環境被保麗龍淹沒了！", width / 2, height / 2);
          return;
        }
        background(15, 20, 35);
        gameTimer += deltaTime / 1000;
        handleInput();

        for (let i = fragments.length - 1; i >= 0; i--) {
          fragments[i].update();
          fragments[i].display();
          if (fragments[i].alpha <= 0) fragments.splice(i, 1);
        }

        player.update();
        player.display();

        if (gameTimer >= BOSS_SPAWN_TIME && !boss) {
          boss = new StyrofoamTitan();
          enemies = [];
        } else if (!boss && frameCount % 60 === 0)
          enemies.push(new NightMarketMonster());

        if (boss) {
          boss.update();
          boss.display();
          if (boss.hp <= 0) {
            noLoop();
            background(0, 200);
            fill(0, 255, 100);
            textAlign(CENTER);
            text("成功淨化保麗龍！", width / 2, height / 2);
          }
        }
        handleCombat();
        drawUI();
        drawJoystick(leftJoy, color(0, 200, 255, 80));
        drawJoystick(rightJoy, color(255, 50, 50, 80));
      }

      function touchStarted() {
        for (let t of touches) {
          if (t.x < width / 2 && !leftJoy.active) {
            leftJoy.active = true;
            leftJoy.id = t.id;
            leftJoy.x = t.x;
            leftJoy.y = t.y;
            leftJoy.currX = t.x;
            leftJoy.currY = t.y;
          } else if (t.x >= width / 2 && !rightJoy.active) {
            rightJoy.active = true;
            rightJoy.id = t.id;
            rightJoy.x = t.x;
            rightJoy.y = t.y;
            rightJoy.currX = t.x;
            rightJoy.currY = t.y;
          }
        }
        return false;
      }
      function touchMoved() {
        for (let t of touches) {
          if (t.id === leftJoy.id) {
            leftJoy.currX = t.x;
            leftJoy.currY = t.y;
          }
          if (t.id === rightJoy.id) {
            rightJoy.currX = t.x;
            rightJoy.currY = t.y;
          }
        }
        return false;
      }
      function touchEnded() {
        let sL = false,
          sR = false;
        for (let t of touches) {
          if (t.id === leftJoy.id) sL = true;
          if (t.id === rightJoy.id) sR = true;
        }
        if (!sL) leftJoy.active = false;
        if (!sR) rightJoy.active = false;
        return false;
      }
      function mousePressed() {
        if (touches.length === 0) touchStarted();
      }
      function mouseDragged() {
        if (touches.length === 0) touchMoved();
      }
      function mouseReleased() {
        if (touches.length === 0) {
          leftJoy.active = false;
          rightJoy.active = false;
        }
      }

      function handleInput() {
        if (leftJoy.active) {
          let a = atan2(leftJoy.currY - leftJoy.y, leftJoy.currX - leftJoy.x);
          let d = dist(leftJoy.x, leftJoy.y, leftJoy.currX, leftJoy.currY);
          let p = constrain(d / (joySize / 2), 0, 1);
          player.vx += cos(a) * 1.5 * p;
          player.vy += sin(a) * 1.5 * p;
        }
        if (rightJoy.active && frameCount % 8 === 0) {
          let a = atan2(
            rightJoy.currY - rightJoy.y,
            rightJoy.currX - rightJoy.x
          );
          if (dist(rightJoy.x, rightJoy.y, rightJoy.currX, rightJoy.currY) > 20)
            bullets.push(new Bullet(player.x, player.y, a));
        }
      }

      function drawJoystick(joy, col) {
        if (joy.active) {
          fill(col);
          noStroke();
          ellipse(joy.x, joy.y, joySize);
          let a = atan2(joy.currY - joy.y, joy.currX - joy.x);
          let d = min(dist(joy.x, joy.y, joy.currX, joy.currY), joySize / 2);
          fill(255, 150);
          ellipse(joy.x + cos(a) * d, joy.y + sin(a) * d, 50);
        }
      }

      class Player {
        constructor() {
          this.x = width / 2;
          this.y = height / 2;
          this.vx = 0;
          this.vy = 0;
          this.hp = 100;
        }
        update() {
          this.vx *= 0.88;
          this.vy *= 0.88;
          this.x += this.vx;
          this.y += this.vy;
          this.x = constrain(this.x, 20, width - 20);
          this.y = constrain(this.y, 20, height - 20);
        }
        display() {
          fill(0, 200, 255);
          stroke(255);
          rect(this.x - 15, this.y - 15, 30, 30, 5);
        }
      }

      class Bullet {
        constructor(x, y, a) {
          this.x = x;
          this.y = y;
          this.a = a;
        }
        update() {
          this.x += cos(this.a) * 12;
          this.y += sin(this.a) * 12;
        }
        display() {
          fill(0, 255, 200);
          noStroke();
          ellipse(this.x, this.y, 10, 10);
        }
      }

      class NightMarketMonster {
        constructor() {
          this.x = random(width);
          this.y = -30;
          this.hp = 3;
        }
        update() {
          let a = atan2(player.y - this.y, player.x - this.x);
          this.x += cos(a) * 2;
          this.y += sin(a) * 2;
        }
        display() {
          fill(100, 200, 100);
          ellipse(this.x, this.y, 30, 30);
        }
      }

      class StyrofoamTitan {
        constructor() {
          this.x = width / 2;
          this.y = 150;
          this.hp = 1000;
        }
        update() {
          this.x = width / 2 + sin(frameCount * 0.02) * 100;
          if (frameCount % 5 === 0)
            fragments.push(
              new Fragment(this.x + random(-40, 40), this.y + random(-30, 30))
            );
          if (frameCount % 40 === 0)
            bossBullets.push(
              new Skewer(
                this.x,
                this.y,
                atan2(player.y - this.y, player.x - this.x)
              )
            );
        }
        display() {
          fill(255);
          stroke(200);
          ellipse(this.x, this.y, 100, 80);
          fill(255, 0, 0, 150);
          ellipse(this.x, this.y, 30, 30);
        }
      }

      class Fragment {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.vy = random(1, 3);
          this.alpha = 255;
        }
        update() {
          this.y += this.vy;
          this.alpha -= 5;
        }
        display() {
          fill(255, this.alpha);
          noStroke();
          rect(this.x, this.y, 5, 5);
        }
      }

      class Skewer {
        constructor(x, y, a) {
          this.x = x;
          this.y = y;
          this.a = a;
        }
        update() {
          this.x += cos(this.a) * 5;
          this.y += sin(this.a) * 5;
        }
        display() {
          fill(255, 255, 0);
          push();
          translate(this.x, this.y);
          rotate(this.a);
          rect(0, -2, 20, 4);
          pop();
        }
      }

      function handleCombat() {
        for (let i = bullets.length - 1; i >= 0; i--) {
          bullets[i].update();
          bullets[i].display();
          if (boss && dist(bullets[i].x, bullets[i].y, boss.x, boss.y) < 50) {
            boss.hp -= 2;
            bullets.splice(i, 1);
            continue;
          }
          for (let j = enemies.length - 1; j >= 0; j--) {
            if (
              dist(bullets[i].x, bullets[i].y, enemies[j].x, enemies[j].y) < 20
            ) {
              enemies[j].hp--;
              bullets.splice(i, 1);
              if (enemies[j].hp <= 0) enemies.splice(j, 1);
              break;
            }
          }
        }
        for (let e of enemies) {
          e.update();
          e.display();
          if (dist(e.x, e.y, player.x, player.y) < 25) player.hp -= 0.5;
        }
        for (let b of bossBullets) {
          b.update();
          b.display();
          if (dist(b.x, b.y, player.x, player.y) < 20) player.hp -= 10;
        }
        if (player.hp <= 0) gameOver = true;
      }

      function drawUI() {
        fill(255);
        textSize(16);
        textAlign(LEFT);
        text(`能源: ${floor(player.hp)}%`, 20, height - 30);
        if (boss) text(`泰坦血量: ${floor(boss.hp)}`, 20, height - 55);
      }
    </script>
  </body>
</html>
